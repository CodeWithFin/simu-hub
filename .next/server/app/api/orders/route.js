"use strict";(()=>{var e={};e.id=146,e.ids=[146],e.modules={399:e=>{e.exports=require("next/dist/compiled/next-server/app-page.runtime.prod.js")},517:e=>{e.exports=require("next/dist/compiled/next-server/app-route.runtime.prod.js")},1016:(e,s,r)=>{r.r(s),r.d(s,{originalPathname:()=>_,patchFetch:()=>S,requestAsyncStorage:()=>g,routeModule:()=>m,serverHooks:()=>f,staticGenerationAsyncStorage:()=>I});var t={};r.r(t),r.d(t,{GET:()=>p,POST:()=>u});var o=r(9303),i=r(8716),n=r(670),a=r(7070),c=r(9145),l=r(5423);let d=()=>"SH"+Date.now().toString(36).toUpperCase()+Math.random().toString(36).substring(2,7).toUpperCase();async function u(e){try{let{customerName:s,phone:r,email:t,productId:o,deliveryMethod:i,deliveryAddress:n}=await e.json();if(!s||!r||!o||!i)return a.NextResponse.json({success:!1,error:"Missing required fields"},{status:400});if("doorstep"===i&&!n)return a.NextResponse.json({success:!1,error:"Delivery address required for doorstep delivery"},{status:400});let{data:u}=await c.O.from("customers").select("id").eq("phone",r).single();if(u){let{data:e,error:r}=await c.O.from("customers").update({name:s,email:t||null}).eq("id",u.id).select().single();r?console.error("Failed to update customer:",r):u=e}else{let{data:e,error:o}=await c.O.from("customers").insert({name:s,phone:r,email:t}).select().single();if(o)throw o;if(!e)return a.NextResponse.json({success:!1,error:"Failed to create customer"},{status:500});u=e}if(!u||!u.id)return a.NextResponse.json({success:!1,error:"Failed to get or create customer"},{status:500});let{data:p,error:m}=await c.O.from("products").select("*").eq("id",o).single();if(m||!p)return a.NextResponse.json({success:!1,error:"Product not found"},{status:404});let g=d(),{data:I,error:f}=await c.O.from("orders").insert({customer_id:u.id,product_id:o,delivery_method:i,delivery_address:"doorstep"===i?n:null,order_reference:g,status:"pending"}).select().single();if(f)throw f;let _=process.env.SHOP_PHONE;if(_){let e=`NEW ORDER #${g}
Customer: ${s}
Phone: ${r}
Product: ${p.brand} ${p.model}
Delivery: ${"doorstep"===i?"Doorstep":"Pickup"}
${"doorstep"===i?`Location: ${n}`:""}
View: http://localhost:3000/admin/orders/${I.id}`;await (0,l.X)(_,e,I.id)}return a.NextResponse.json({success:!0,data:{...I,product:p,customer:{name:s,phone:r,email:t}}},{status:201})}catch(e){return a.NextResponse.json({success:!1,error:e.message},{status:500})}}async function p(e){try{let s=e.nextUrl.searchParams,r=s.get("status"),t=s.get("deliveryMethod"),o=s.get("startDate"),i=s.get("endDate"),n=s.get("search"),l=c.O.from("orders").select(`
        *,
        customers:customer_id (id, name, phone, email),
        products:product_id (id, brand, model, price, image_url)
      `).order("created_at",{ascending:!1});r&&(l=l.eq("status",r)),t&&(l=l.eq("delivery_method",t)),o&&(l=l.gte("created_at",o)),i&&(l=l.lte("created_at",i));let{data:d,error:u}=await l;if(u)throw u;let p=d;if(n){let e=n.toLowerCase();p=d?.filter(s=>s.order_reference?.toLowerCase().includes(e)||s.customers?.name?.toLowerCase().includes(e)||s.customers?.phone?.includes(n))||[]}return a.NextResponse.json({success:!0,data:p})}catch(e){return a.NextResponse.json({success:!1,error:e.message},{status:500})}}let m=new o.AppRouteRouteModule({definition:{kind:i.x.APP_ROUTE,page:"/api/orders/route",pathname:"/api/orders",filename:"route",bundlePath:"app/api/orders/route"},resolvedPagePath:"/home/finley/Finley-personal /simu-hub/app/api/orders/route.ts",nextConfigOutput:"",userland:t}),{requestAsyncStorage:g,staticGenerationAsyncStorage:I,serverHooks:f}=m,_="/api/orders/route";function S(){return(0,n.patchFetch)({serverHooks:f,staticGenerationAsyncStorage:I})}},5423:(e,s,r)=>{r.d(s,{X:()=>o});var t=r(9145);let o=async(e,s,r)=>{try{let o=process.env.SMS_ENDPOINT||process.env.TILIL_SMS_URL||"https://api.tililtech.com/sms/v3/sendsms",i=process.env.TILIL_API_KEY,n=process.env.TILIL_SHORTCODE||process.env.TILIL_SENDER_ID||"SIMUHUB";if(!i)return console.warn("Tilil API key not configured. SMS not sent."),console.warn("Required: TILIL_API_KEY"),{success:!1,error:"SMS service not configured"};let a=e.replace(/\s+/g,"").replace(/^\+/,"");console.log("Sending SMS via Tilil to:",a),console.log("Using endpoint:",o),console.log("Using shortcode:",n);let c={api_key:i,service:0,mobile:a,response_type:"json",shortcode:n,message:s};console.log("Tilil SMS Request:",JSON.stringify({...c,api_key:`${i.substring(0,10)}...`,message:`${s.substring(0,50)}...`},null,2));let l=await fetch(o,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(c)}),d=await l.json();console.log("Tilil SMS response status:",l.status),console.log("Tilil SMS response:",JSON.stringify(d,null,2));let u=Array.isArray(d)?d[0]:d;if(u&&u.status_code&&"1000"!==u.status_code&&"1"!==u.status_code&&1e3!==u.status_code&&1!==u.status_code){let o=u.status_desc||"SMS sending failed";return console.error("❌ Tilil SMS error:",o),console.error("Status code:",u.status_code),console.error("Full response:",u),"1001"===u.status_code?(console.error("⚠️  SENDER ID ERROR: The shortcode/sender ID is not registered with Tilil"),console.error("\uD83D\uDCA1 Solution: Log into your Tilil dashboard and verify your approved sender IDs"),console.error("Current shortcode:",n)):"1006"===u.status_code||"1013"===u.status_code?(console.error("⚠️  API KEY ERROR: The API key is invalid or expired"),console.error("\uD83D\uDCA1 Solution: Verify your TILIL_API_KEY in .env.local")):"1003"===u.status_code?(console.error("⚠️  PHONE NUMBER ERROR: Invalid mobile number format"),console.error("Current number:",a)):"1004"===u.status_code&&(console.error("⚠️  CREDIT ERROR: Insufficient SMS credits"),console.error("\uD83D\uDCA1 Solution: Top up your Tilil account")),r&&await t.O.from("sms_logs").insert({order_id:r,recipient_phone:e,message_type:"notification",message_content:s,status:"failed",response:JSON.stringify(d)}),{success:!1,error:o}}if(!l.ok)return console.error("❌ Tilil SMS HTTP error:",d),r&&await t.O.from("sms_logs").insert({order_id:r,recipient_phone:e,message_type:"notification",message_content:s,status:"failed",response:JSON.stringify(d)}),{success:!1,error:d.message||"SMS sending failed"};return console.log("✅ SMS sent successfully!"),console.log("Message ID:",u.message_id),console.log("Credit balance:",u.credit_balance),r&&await t.O.from("sms_logs").insert({order_id:r,recipient_phone:e,message_type:"notification",message_content:s,status:"sent",sent_at:new Date().toISOString(),response:JSON.stringify(d)}),{success:!0,data:d}}catch(o){return console.error("❌ SMS sending exception:",o),r&&await t.O.from("sms_logs").insert({order_id:r,recipient_phone:e,message_type:"notification",message_content:s,status:"failed",response:JSON.stringify({error:o.message})}),{success:!1,error:o.message}}}},9145:(e,s,r)=>{r.d(s,{O:()=>i});var t=r(7857);let o=null,i=function(){if(o)return o;try{let e="https://moxqcjveracxuthydide.supabase.co",s="eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1veHFjanZlcmFjeHV0aHlkaWRlIiwicm9sZSI6InNlcnZpY2Vfcm9sZSIsImlhdCI6MTc2ODQzODYzNSwiZXhwIjoyMDg0MDE0NjM1fQ.8lLOdRN8EfNC21Kj5a3RtGfICCCPYi4ZbkFbvDcDqEg";if(!e||!s)return console.warn("⚠️  Supabase environment variables not set. API calls will fail."),o=(0,t.eI)("https://placeholder.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0");return o=(0,t.eI)(e,s)}catch(e){return console.error("Error creating Supabase client:",e),o=(0,t.eI)("https://placeholder.supabase.co","eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZS1kZW1vIiwicm9sZSI6ImFub24iLCJleHAiOjE5ODM4MTI5OTZ9.CRXP1A7WOeoJeXxjNni43kdQwgnWNReilDMblYTn_I0")}}()}};var s=require("../../../webpack-runtime.js");s.C(e);var r=e=>s(s.s=e),t=s.X(0,[276,564],()=>r(1016));module.exports=t})();